---
publishDate: 2024-04-27
title: åœ¨è°·æ­Œæµè§ˆå™¨æ’ä»¶ä¸­å»ºç«‹ socket é€šä¿¡
excerpt: åœ¨è°·æ­Œæµè§ˆå™¨ä¸­å»ºç«‹ socket é€šä¿¡ï¼Œä»¥æ­¤æ¥æ¨é€é€šçŸ¥
image: '~/assets/images/blog/akira-fIlM9bT3WaM-unsplash.webp'
category: client
tags:
  - extension
  - google
  - socket
metadata:
  image_author:
    link: https://unsplash.com/@akira_b
    name: akira_b
---

### èƒŒæ™¯

å¸Œæœ›é€šè¿‡æ’ä»¶ç»™ç”¨æˆ·æ¨é€æ¶ˆæ¯ã€‚

### æ­¥éª¤

1. åˆ›å»º `manifest.json` æ–‡ä»¶

```json
{
  "name": "å¤§è‘±Ding",
  "description": "å¿«å›æ¶ˆæ¯ï¼ŒDing!",
  "version": "1.0.1",
  "manifest_version": 3,
  "icons": {
    "16": "assets/16.png",
    "32": "assets/32.png",
    "48": "assets/48.png",
    "128": "assets/128.png"
  },
  "action": {
    "default_popup": "popup/popup.html"
  },
  "permissions": ["notifications"],
  "minimum_chrome_version": "116",
  "background": {
    "service_worker": "background.js",
    "type": "module"
  }
}
```

2. åˆ›å»º `background.js` æ–‡ä»¶ï¼Œå®ƒæ˜¯é€šä¿¡çš„å…³é”®

```javascript
import { sendMessage, getMessage } from './utils/socket.js';
const TEN_SECONDS_MS = 10 * 1000;
let webSocket = null;
let keepAliveIntervalId = null;
connect();

chrome.runtime.onStartup.addListener(() => {
  if (!webSocket) connect();
});

function connect() {
  if (keepAliveIntervalId) clearInterval(keepAliveIntervalId);
  webSocket = new WebSocket('wss://api.ll1025.cn');

  keepAlive();

  webSocket.onopen = () => {
    chrome.action.setIcon({ path: 'assets/128-success.png' });
  };

  webSocket.onmessage = (event) => {
    getMessage(event.data);
  };

  webSocket.onclose = () => {
    chrome.action.setIcon({ path: 'assets/128-close.png' });
    webSocket = null;
    setTimeout(connect, 2000);
  };
}

function keepAlive() {
  // è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœåœ¨åå°æ²¡æœ‰é€šä¿¡ï¼Œä¼šè¢«ä¼‘çœ 
  keepAliveIntervalId = setInterval(() => {
    if (webSocket) {
      sendMessage(webSocket, 'ping', '1');
    } else {
      clearInterval(keepAliveIntervalId);
    }
  }, TEN_SECONDS_MS);
}
```

3. åˆ›å»º `/utils/socket.js` æ–‡ä»¶

```javascript
export function sendMessage(webSocket, type, value) {
  webSocket.send(JSON.stringify({ type, value }));
}

export function updateBadgeText() {
  chrome.action.getBadgeText({}, function (result) {
    let newValue = parseInt(result ? result : 0) + 1;
    chrome.action.setBadgeText({ text: newValue.toString() });
  });
}

export function getMessage(data) {
  let { type, value } = JSON.parse(data);
  switch (type) {
    case 'notification':
      updateBadgeText();
      const options = {
        type: 'basic',
        iconUrl: '/assets/128.png', // é€šçŸ¥å›¾æ ‡
        title: 'å¤§è‘±ç»™ä½ å‘äº†æ¶ˆæ¯',
        message: value,
      };
      // å‘é€é€šçŸ¥
      chrome.notifications.create(options);
      break;
  }
}
```

ä¸»è¦å°±æ˜¯ä¸Šé¢ä¸‰ä¸ªæ­¥éª¤ï¼Œæ­¤æ’ä»¶å¼€æºåœ°å€ https://github.com/Dacong-wu/google-plugin

### æ³¨æ„äº‹é¡¹

1. ä½¿ç”¨çš„ manifest_version ä¸º 3ï¼Œå®˜æ–¹æ–‡æ¡£åœ°å€ https://developer.chrome.com/docs/extensions?hl=zh-cn ï¼ˆéœ€è¦ç§‘å­¦ä¸Šç½‘ï¼‰è¯·ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†ã€‚
2. è¯·ä¸è¦ socket.io æµ‹è¯•æ— æ•ˆã€‚
3. å‘å¸ƒåˆ°è°·æ­Œåº”ç”¨å¸‚åœºæ³¨å†Œéœ€è¦ 5 ç¾å…ƒï¼Œå¾®è½¯å•†åº—ä¸éœ€è¦è´¹ç”¨ï¼Œä½†æ˜¯æ³¨å†Œä¼šæŠ¥é”™ï¼Œè¯·å°†åŸå¸‚ç”¨å¤§å†™è‹±æ–‡è¡¨ç¤ºï¼Œä¾‹å¦‚ åŒ—äº¬-BJ
4. åç«¯éƒ¨åˆ†æ²¡æœ‰å¼€æºï¼Œæœ‰éœ€è¦è¯·ç”¨é‚®ç®±è”ç³»ğŸ¤£
