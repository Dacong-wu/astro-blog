---
publishDate: 2024-04-27
title: åˆ›å»ºè‡ªå®šä¹‰ action
excerpt: åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ action ç”¨äºå°† action ä¸­ç”Ÿæˆçš„ dist æ–‡ä»¶å¤¹ä¸Šä¼ åˆ°æœåŠ¡å™¨
image: '~/assets/images/blog/eugene-golovesov-ZRjnk4MpWA4-unsplash.jpg'
category: ops
tags:
  - action
  - github
metadata:
  image_author:
    link: https://unsplash.com/@eugene_golovesov
    name: eugene_golovesov
---

### èƒŒæ™¯

å½“æˆ‘ä»¬æŠŠ Vue ä»£ç æäº¤åˆ° github åï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡ action å»æ„å»ºç”Ÿæˆä»£ç ï¼Œå¹¶å°†ç”Ÿäº§ä»£ç å¤åˆ¶åˆ°ç”Ÿäº§æœåŠ¡å™¨çš„æŒ‡å®šç›®å½•ã€‚æ„å»ºè¿‡ç¨‹éå¸¸ç®€å•ï¼Œä½†æ˜¯è¦å¤åˆ¶ç”Ÿäº§ä»£ç åˆ°æŒ‡å®šæœåŠ¡å™¨ç›®å½•ï¼Œè¿™ä¸ªéƒ¨åˆ†å°±éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ã€‚

### æ­¥éª¤

1. æ–°å»ºä¸€ä¸ª github ä»“åº“ **sftp-deploy-action**
2. åˆ›å»º **action.yml** æ–‡ä»¶

```yaml
name: 'SFTP Deploy Action'
description: 'Deploy files to a server via SFTP.'
author: 'dacong-wu'
inputs:
  SFTP_HOST:
    description: 'The SFTP host.'
    required: true
  SFTP_USERNAME:
    description: 'The SFTP username.'
    required: true
  SFTP_PASSWORD:
    description: 'The SFTP password.'
    required: true
  SFTP_REMOTE:
    description: 'The remote directory on the SFTP server.'
    required: true
runs:
  using: 'node20'
  main: 'deploy-to-sftp.js'
```

3. åˆ›å»º **deploy-to-sftp.js** æ–‡ä»¶

```javascript
const path = require('path');
const fs = require('fs');
const Client = require('ssh2-sftp-client');
const dayjs = require('dayjs');
const utc = require('dayjs/plugin/utc');
const timezone = require('dayjs/plugin/timezone');
const logSymbols = require('log-symbols');
const core = require('@actions/core');
dayjs.extend(utc);
dayjs.extend(timezone);

let remote = core.getInput('SFTP_REMOTE');
let localPath = path.join(process.cwd(), 'dist'); // ä¿®æ”¹è·¯å¾„ä»¥é€‚åº”æ–°ç¯å¢ƒ
let fileNumber = getPathFileNumber(localPath);
let steps = 100 / fileNumber;
let percent = 0;

const sftp = new Client();

async function deploy() {
  console.log(logSymbols.info, 'æ­£åœ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨...');
  sftp
    .connect({
      host: core.getInput('SFTP_HOST'),
      port: 22,
      username: core.getInput('SFTP_USERNAME'),
      password: core.getInput('SFTP_PASSWORD'),
    })
    .then(async () => {
      let fromPath = remote + '/dist';
      let uploadPath = remote + '/upload';
      let toPath = remote + '/backup/' + dayjs().tz('Asia/Shanghai').format('YYYY-MM-DD(HH:mm:ss)');
      await sftp.uploadDir(localPath, uploadPath);
      if (!(await sftp.exists(remote + '/backup/'))) sftp.mkdir(remote + '/backup/', true);
      if (await sftp.exists(fromPath)) {
        await sftp.rename(fromPath, toPath);
      }
      await sftp.rename(uploadPath, fromPath);
    })
    .then(() => {
      console.log(logSymbols.success, 'ä¸Šä¼ æˆåŠŸğŸ˜');
      return sftp.end();
    })
    .catch((err) => {
      console.log(logSymbols.error, `ä¸Šä¼ å¤±è´¥ğŸ˜­\n${err}`);
      return sftp.end();
    });
  sftp.on('upload', () => {
    percent += steps;
    console.log(logSymbols.info, `ä¸Šä¼ è¿›åº¦ï¼š${Math.round(percent)}%`);
  });
}

function getPathFileNumber(folder) {
  var number = 0;
  function readFolder(folder) {
    try {
      let files = fs.readdirSync(folder);
      files.forEach((item) => {
        let fileItemPath = path.join(folder, item);
        let stat = fs.statSync(fileItemPath);
        if (stat.isFile()) number++;
        else readFolder(fileItemPath);
      });
    } catch (err) {
      console.log(logSymbols.error, `è¯»å–æ–‡ä»¶é”™è¯¯ğŸ˜–\n${err}`);
    }
  }
  readFolder(folder);
  return number;
}

deploy();
```

3. æ‰§è¡Œ `npm init -y` åˆ›å»º **package.json** æ–‡ä»¶
4. å®‰è£…éœ€è¦çš„ä¾èµ– `npm i  @actions/core dayjs log-symbols ssh2-sftp-client`
5. åˆ›å»º **README.md** æ–‡ä»¶ï¼Œå¯¹é¡¹ç›®è¿›è¡Œè¯´æ˜

```markdown
## Please refer to action.yml to get the data you need to provide.

1. Version 1 only supports logging into the server with a username and password.
2. Version 1 only supports Vue in principle because the build output directory is dist.
3. The SFTP_REMOTE address does not need to include dist and /.
```

ä¸»è¦å°±æ˜¯ä¸Šé¢äº”ä¸ªæ­¥éª¤ï¼Œæ­¤ action å¼€æºåœ°å€ https://github.com/Dacong-wu/sftp-deploy-action

### æ³¨æ„äº‹é¡¹

1. ä½ éœ€è¦ä½¿ç”¨ @actions/core æ¥æ¥å—å‚æ•°
1. æ³¨æ„è®¾ç½® dayjs çš„æ—¶åŒºï¼Œä¸ç„¶å¤‡ä»½æ–‡ä»¶å¤¹çš„æ—¶é—´ä¼šæœ‰é—®é¢˜

### ä½¿ç”¨

1. åœ¨ä½  action çš„ jobs çš„ steps å¢åŠ å¦‚ä¸‹æ­¥éª¤

```yaml
- name: æ‰§è¡Œéƒ¨ç½²
  	uses: Dacong-wu/sftp-deploy-action@main
    with:
    	SFTP_HOST: ${{ secrets.USER_HOST }}
    	SFTP_USERNAME: ${{ secrets.USER_NAME }}
    	SFTP_PASSWORD: ${{ secrets.PASSWORD }}
    	SFTP_REMOTE: ${{secrets.USER_TARGET}}
```

2. åœ¨ github ä¸­æ·»åŠ å¯¹åº”çš„ secret
