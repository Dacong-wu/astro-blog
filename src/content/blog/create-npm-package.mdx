---
publishDate: 2023-12-12
title: åˆ›å»ºä¸€ä¸ª npm åŒ…
excerpt: åˆ¶ä½œä¸€ä¸ªé€‚ç”¨äº Koa çš„ npm åŒ…
image: '~/assets/images/blog/adam-chang-IWenq-4JHqo-unsplash.jpg'
category: package
tags:
  - npm
  - package
metadata:
  image_author:
    link: https://unsplash.com/@sametomorrow
    name: sametomorrow
---

å‰æœŸå‡†å¤‡å·¥ä½œï¼š

1. åˆ›å»ºä¸€ä¸ª npm è´¦å·ï¼Œ[npm-signup](https://www.npmjs.com/signup)
2. å°†ä½ çš„ npm registries è®¾ç½®ä¸ºå®˜æ–¹çš„ï¼Œæ¨èä½¿ç”¨ [nrm](https://www.npmjs.com/package/nrm)

æ­£å¼å¼€å§‹ï¼š

1. åˆ›å»ºç›®å½• `dacong-koa-verifytoken` (å‡è®¾æˆ‘éœ€è¦åˆ¶ä½œä¸€ä¸ªç”¨äºéªŒè¯ token çš„åŒ…)

2. æ‰§è¡Œåˆå§‹åŒ– `npm init -y`

3. å®‰è£…ä¾èµ–ï¼Œ`npm install jsonwebtoken koa-router`

4. åˆ›å»º `index.js` æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶ä¸ºå…¥å£æ–‡ä»¶

   ```javascript
   const verifyToken = require('./verifytoken');
   module.exports = { verifyToken };
   ```

5. åˆ›å»º `verifytoken.js` æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶ä¸ºä¸»è¦åŠŸèƒ½æ–‡ä»¶

   ```javascript
   const jwt = require('jsonwebtoken');
   function setRouterOpts(opts) {
     opts = opts || {};
     /*
     opts æ˜¯å¼•ç”¨åŒ…æ—¶ï¼Œä¼ å…¥çš„ä¿¡æ¯
     secret ä¸ºç­¾åç§˜é’¥
     excludedPaths ä¸ºéœ€è¦æ’é™¤çš„è·¯å¾„
     NODE_ENV ä¸ºç¨‹åºè¿è¡Œç¯å¢ƒå€¼
     */
     let { secret = 'secret', excludedPaths = [], NODE_ENV = 'production' } = opts;
     return async (ctx, next) => {
       if (!excludedPaths.includes(ctx.path) && NODE_ENV === 'production') {
         const token = ctx.request.headers.token;
         // æ£€æŸ¥è¯·æ±‚å¤´ä¸­æ˜¯å¦åŒ…å«ä»¤ç‰Œ
         if (!token) {
           ctx.status = 401; // ç¼ºå¤±ä»¤ç‰Œï¼Œè¿”å›æœªç»æˆæƒçŠ¶æ€ç 
           return;
         }
         try {
           const info = jwt.verify(token, secret);
           ctx.user_data = info.data; // æ­¤ä¸ºç”¨æˆ·ä¿¡æ¯ï¼Œæ˜¯åˆ›å»º token æ—¶è®¾ç½®çš„
         } catch (err) {
           if (err?.message === 'jwt expired') {
             console.error(`Title:TokenéªŒè¯é”™è¯¯-tokenè¿‡æœŸ`);
           } else {
             console.error(`Title:TokenéªŒè¯é”™è¯¯\nErr_stack:${err.stack}\n`);
           }
           ctx.status = 401;
         }
       }
       await next();
     };
   }
   module.exports = setRouterOpts;
   ```

6. æ·»åŠ  `.gitignore` æ–‡ä»¶ï¼Œæ·»åŠ éœ€è¦å¿½ç•¥æäº¤çš„æ–‡ä»¶

   ```
   node_modules
   .gitignore
   *.DS_Store
   logs
   *.log
   package-lock.json
   ```

7. ä¿®æ”¹ `package.json` æ–‡ä»¶ï¼ŒåŠ å…¥å…³é”®è¯ï¼Œæè¿°ç­‰ä¿¡æ¯

   ```json
   {
     "name": "koa-verifytoken",
     "version": "1.0.0",
     "description": "",
     "main": "index.js",
     "scripts": {
       "test": "echo \"Error: no test specified\" && exit 1"
     },
     "keywords": ["token", "verifytoken", "koa-token", "verify-jwt"],
     "author": "",
     "license": "ISC",
     "dependencies": {
       "jsonwebtoken": "^9.0.2",
       "koa-router": "^12.0.0"
     }
   }
   ```

8. åˆ›å»º `README.md` æ–‡ä»¶ï¼Œå¯¹æ­¤åŒ…åšä¸€ä¸ªä½¿ç”¨è¯´æ˜

   ````markdown
   ### å®‰è£…

   ```shell
   npm install koa-verifytoken@latest
   ```

   ### ä½¿ç”¨

   ```javascript
   /* ğŸŒ° /router.js
   secret:tokenç§˜é’¥ default:'secret'
   excludedPaths:éœ€è¦æ’é™¤éªŒè¯çš„è·¯ç”±hostå®Œæ•´åœ°å€ ğŸŒ° https://test.cn/api/8888 default:[]
   NODE_ENV:Nodeçš„ç¯å¢ƒï¼Œproductionç¯å¢ƒæ‰ä¼šæ‰§è¡ŒéªŒè¯ï¼Œæ–¹ä¾¿æœ¬åœ°å¼€å‘ default:'production'
   */
   const router = require('koa-router')();
   const { verifyToken } = require('koa-verifytoken');

   router.use(verifytoken({ secret, excludedPaths, NODE_ENV }));
   router.use('/other'); // å…¶å®ƒéœ€è¦éªŒè¯çš„è·¯ç”±
   module.exports = router;
   ```

   ### æ³¨æ„äº‹é¡¹

   1. è¿™æ˜¯ `Koa` çš„æ’ä»¶
   2. `NODE_ENV` ä¸º `production` æ—¶ï¼Œæ‰ä¼šç”Ÿæ•ˆ
   3. `excludedPaths` ä¸ºä¸€ä¸ª `host` è·¯å¾„æ•°ç»„
   ````

9. ç¡®è®¤æ— è¯¯å°±å¯ä»¥æäº¤äº†ï¼Œé»˜è®¤çš„åŒ…åï¼Œä¸º `package.json` é‡Œé¢ `name` çš„å€¼ï¼Œä¸å¯é‡å¤

10. æ‰§è¡Œ `npm publish` æäº¤ï¼Œæ ¹æ®æ§åˆ¶å°æç¤ºå®Œæˆç™»å½•å³å¯

11. è¿™ä¸ªæ—¶å€™ï¼Œåœ¨ npm ä¸­å°±å¯ä»¥æœç´¢åˆ°æ­¤åŒ…äº†

æ³¨æ„ï¼š

1. å®é™…æˆ‘å·²ç»å‘å¸ƒçš„åŒ…åä¸º `dacong-koa-verifytoken` `koa-verifytoken` åªæ˜¯ä¸€ä¸ªç”¨äºæ•™ç¨‹çš„åå­—
2. è¿™åªæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼Œå¹¶æ²¡æœ‰æ‰“åŒ…
3. è¯·æ³¨æ„æ•™ç¨‹ä¸­ä¾èµ–åŒ…çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¦‚æœä¾èµ–åŒ…ç‰ˆæœ¬æœ‰å¤§çš„å˜åŠ¨ï¼Œå¯èƒ½ä¼šä¸é€‚ç”¨
