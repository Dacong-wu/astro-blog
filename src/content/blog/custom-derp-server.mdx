---
publishDate: 2024-07-09
title: è‡ªå®šä¹‰ DERP æœåŠ¡å™¨ï¼ˆä¸­ç»§ï¼‰
excerpt: è‡ªå®šä¹‰ DERP ä¸­ç»§ï¼Œä»¥è§£å†³ä½¿ç”¨ tailscale å»¶æ—¶é—®é¢˜
image: '~/assets/images/blog/boliviainteligente-QN-8MkXgSQc-unsplash.jpg'
category: ops
tags:
  - tailscale
  - derp
  - docker
metadata:
  image_author:
    link: https://unsplash.com/@boliviainteligente
    name: boliviainteligente
---

åœ¨ä½¿ç”¨ Tailscale æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°åœ¨æŸäº›ç½‘ç»œç¯å¢ƒä¸‹æ— æ³•è¿›è¡Œç‚¹å¯¹ç‚¹è¿æ¥çš„æƒ…å†µã€‚è¿™æ—¶ï¼Œæµé‡ä¼šé€šè¿‡ä¸­ç»§æœåŠ¡å™¨ä¼ è¾“ã€‚ç”±äº Tailscale å®˜æ–¹æ²¡æœ‰åœ¨ä¸­å›½å¤§é™†éƒ¨ç½²ä¸­ç»§æœåŠ¡å™¨ï¼Œè¿™ä¼šå¯¼è‡´è¾ƒé«˜çš„å»¶è¿Ÿå’Œä¸¢åŒ…ã€‚å› æ­¤ï¼Œæˆ‘éœ€è¦è‡ªå·±éƒ¨ç½²ä¸€å°ä¸­ç»§æœåŠ¡å™¨æ¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£äº†è§£è¯¦ç»†éƒ¨ç½²æ­¥éª¤ï¼š[Tailscale å®˜æ–¹æ–‡æ¡£](https://tailscale.com/kb/1118/custom-derp-servers)ã€‚

---

## 1. ä¸€å°æ‹¥æœ‰å…¬ç½‘ IP çš„ä¸»æœº

æˆ‘æ¨èä½¿ç”¨ docker éƒ¨ç½²æœåŠ¡ï¼Œä½ ä¹Ÿå¯ä»¥ä¸è¿™æ ·åšğŸ˜ƒã€‚ä¸»æœºé˜²ç«å¢™éœ€è¦æ”¾å¼€ 3478/UDP å’Œ 80&443/TCP ç«¯å£ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰ç«¯å£ï¼ˆä¸‹é¢æ–¹æ¡ˆä½¿ç”¨è‡ªå®šä¹‰ç«¯å£å®Œæˆï¼‰ã€‚

<span style="color:red">æ³¨æ„ï¼šä¸‹é¢æ–¹æ¡ˆå‡è®¾ä½ ä½¿ç”¨çš„åŸŸåä¸º qq.comï¼Œç«¯å£ä¸º 8443ã€‚å®é™…éƒ¨ç½²æ—¶ï¼Œè¯·æ›¿æ¢ä¸ºè‡ªå·±çš„ä¿¡æ¯ã€‚</span>

---

## 2. åˆ›å»ºå®¹å™¨é•œåƒå¹¶è¿è¡Œå®¹å™¨

1. é…ç½® Dockerfile æ–‡ä»¶

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM golang:latest AS builder
WORKDIR /app
ENV GOPROXY=https://goproxy.cn # ä½¿ç”¨å›½å†…çš„ä»£ç†
RUN go install tailscale.com/cmd/derper@latest

# è¿è¡Œé˜¶æ®µ
FROM ubuntu:24.04
WORKDIR /app
ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    mkdir -p /app/certs

# é»˜è®¤å€¼
ENV DERP_DOMAIN qq.com
ENV DERP_ADDR :8443
ENV DERP_CERT_MODE manual
ENV DERP_CERT_DIR /app/certs
ENV DERP_STUN true
ENV DERP_HTTP_PORT -1
ENV DERP_VERIFY_CLIENTS false

COPY --from=builder /go/bin/derper .

# å…·ä½“çš„é…ç½®ä¿¡æ¯å¯ä»¥å‚è€ƒ https://github.com/tailscale/tailscale/blob/main/cmd/derper/derper.go
CMD /app/derper \
--hostname=$DERP_DOMAIN \
--certmode=$DERP_CERT_MODE \
--certdir=$DERP_CERT_DIR \
--a=$DERP_ADDR \
--stun=$DERP_STUN  \
--http-port=$DERP_HTTP_PORT \
--verify-clients=$DERP_VERIFY_CLIENTS
```

2. é…ç½® docker-compose.yml æ–‡ä»¶

è¿™é‡Œéœ€è¦æ³¨æ„Â `/opt/cert` ä¸ºå®¿ä¸»æœºè¯ä¹¦å­˜æ”¾åœ°å€ï¼Œè¯·ä»¥å®é™…å€¼æ›¿æ¢ã€‚

**æ³¨æ„**ï¼šè¯ä¹¦æ ¼å¼éœ€è¦æ»¡è¶³ `**.crt` å’Œ `**.key`ï¼Œä¾‹å¦‚ `qq.com.crt` å’Œ `qq.com.key`ã€‚

```yaml
services:
  derper:
    build: .
    container_name: derper
    network_mode: "host"
    environment:
      # ä½ å¯ä»¥è‡ªè¡Œä¿®æ”¹å¯¹åº”çš„ç¯å¢ƒå˜é‡çš„å€¼
      # - hostname=cc.com
    volumes:
      - /opt/cert:/app/certs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    restart: always
```

3. å¯åŠ¨å®¹å™¨

   `docker compose up -d`

---

## 3. åœ¨ Tailscale æ§åˆ¶é¢æ¿ä¿®æ”¹ `Access controls` é…ç½®

å¢åŠ  `derpMap` å±æ€§ï¼Œå¹¶é…ç½®ä¸€ä¸‹å†…å®¹ï¼Œå¦‚æœä¿å­˜å¤±è´¥ï¼Œæœ‰å¯èƒ½æ˜¯æµè§ˆå™¨å…¼å®¹é—®é¢˜ï¼Œè¯·ä½¿ç”¨è°·æ­Œç­‰æµè§ˆå™¨ã€‚

- `OmitDefaultRegions` åªä½¿ç”¨è‡ªå®šä¹‰ä¸­ç»§

```json
"derpMap": {
    "OmitDefaultRegions": true,
    "Regions": {
      "901": {
        "RegionID": 900,
        "RegionCode": "qqDerp",
        "Nodes": [
          {
            "Name": "qqDerp",
            "RegionID": 900,
            "DERPPort": 8443,
            "HostName": "qq.com"
          }
        ]
      }
    }
}
```

---

## 4. éªŒè¯ DERP ä¸­ç»§æ˜¯å¦ç”Ÿæ•ˆ

1. æµè§ˆ https://qq.com:8443 ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€äº›æç¤ºåŒ…æ‹¬ `This is a Tailscale DERP server.`
2. åœ¨ç»ˆç«¯ä½¿ç”¨å‘½ä»¤ `tailscale netcheck` æŸ¥çœ‹ Report ä¿¡æ¯ï¼ŒéªŒè¯ `DERP latency` æ˜¯å¦ä¸ºä½ è‡ªå®šä¹‰çš„
3. å°†æ‰‹æœºåˆ‡æ¢ä¸ºç§»åŠ¨æ•°æ®æ¨¡å¼ï¼Œç”µè„‘ç»ˆç«¯ä½¿ç”¨ `tailscale ping ` æŸ¥çœ‹ï¼Œåº”è¯¥ä¼šåŒ…æ‹¬è¿™äº›ä¿¡æ¯ `pong from iphone-14-pro (100.*.*.*) via DERP(qqDerp) in 49ms`

ğŸŠğŸŠ åˆ°è¿™é‡Œï¼Œä½ å·²ç»é¡ºåˆ©å®Œæˆäº†ä¸­ç»§æœåŠ¡çš„é…ç½®ï¼Œæ­å–œï¼ç°åœ¨ï¼Œä½ å¯ä»¥è‡ªç”±ä½¿ç”¨å®ƒäº†ã€‚

---

ğŸ˜‘ğŸ˜‘ä½†æ˜¯æœ‰äº›ç‰¹æ®Šçš„åœ°æ–¹æˆ‘è¿˜æ˜¯éœ€è¦å‘Šè¯‰ä½ ï¼Œä¸­ç»§é»˜è®¤å¹¶ä¸ä¼šæ£€éªŒå®¢æˆ·ç«¯çš„æµé‡ï¼Œè¿™å°±æ„å‘³ç€ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ä½ çš„ä¸­ç»§ã€‚ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå‰æï¼Œå°±æ˜¯ä»–éœ€è¦çŸ¥é“ä½ çš„åŸŸå+ç«¯å£ï¼ˆæ˜¾ç„¶ä»–ä¸çŸ¥é“ğŸ¤£ï¼‰ã€‚

å¦‚æœä½ ä¸æƒ³è®©å…¶å®ƒäººä½¿ç”¨ï¼Œä½ å¯ä»¥åœ¨ä½ éƒ¨ç½²çš„ä¸»æœºä¸Šå®‰è£… tailscale æœåŠ¡ï¼Œç„¶åç™»å½•ä½ çš„è´¦å·ã€‚æœ€ååœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™æŒ‚è½½å®¿ä¸»æœºçš„ `tailscaled`ï¼Œä¸‹é¢æ˜¯æ›´æ–°åçš„ `docker-compose.yml`

```yaml
services:
  derper:
    build: .
    container_name: derper
    network_mode: "host"
    environment:
      # ä½ å¯ä»¥è‡ªè¡Œä¿®æ”¹å¯¹åº”çš„ç¯å¢ƒå˜é‡çš„å€¼
      - DERP_VERIFY_CLIENTS=true
    volumes:
      - /opt/cert:/app/certs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      # è¿™æ˜¯é»˜è®¤ linux ä¸‹çš„åœ°å€ï¼Œè¯·è‡ªå·±ç”„åˆ«
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock
    restart: always
```
